# æœåŠ¡å™¨ç›‘æ§åº”ç”¨ï¼ˆ3ï¼‰ï¼šç›‘æ§å‘Šè­¦é€šçŸ¥å¼€å‘

å¼€å‘å®Œç›‘æ§æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¹‹åï¼Œå°±å·²ç»æƒ³å¥½äº†åç»­æœ‰å¿…è¦çš„è¯æŠŠç›‘æ§å‘Šè­¦é€šçŸ¥ä¹Ÿæä¸Šæ—¥ç¨‹ï¼Œå½“æ—¶å·®ä¸å¤šå·²ç»æƒ³å¥½äº†è¦åšçš„éœ€æ±‚ï¼Œç°åœ¨å·²ç»æŠŠå‘Šè­¦é€šçŸ¥åŠŸèƒ½å®ç°äº†ï¼Œä¹Ÿå·²ç»ä¸Šçº¿ä½¿ç”¨ï¼Œç°åœ¨åˆ†äº«ä¸€ä¸‹ã€‚

è¿™ä¸ªåŠŸèƒ½å…¶å®å¾ˆç®€å•ï¼Œå°±ä¾èµ–ä¸¤ä¸ªåŠŸèƒ½ç‚¹ï¼š

- Django è‡ªå¸¦çš„é‚®ä»¶é€šçŸ¥èƒ½åŠ›
- å®šæ—¶ä»»åŠ¡èƒ½åŠ›

## éœ€æ±‚åˆ†æ

æˆ‘åœ¨ [æœåŠ¡å™¨ç›‘æ§åº”ç”¨ï¼ˆ1ï¼‰ï¼šæœåŠ¡ç«¯å¼€å‘](https://tendcode.com/subject/article/server-status-1/#ä¸‹ä¸€æ­¥ "æœåŠ¡å™¨ç›‘æ§åº”ç”¨ï¼ˆ1ï¼‰ï¼šæœåŠ¡ç«¯å¼€å‘") çš„ç»“å°¾å…¶å®ä¹Ÿå¤§è‡´æè¿°äº†ä¸€ä¸‹å¯¹äºç›‘æ§å‘Šè­¦é€šçŸ¥çš„éœ€æ±‚ç‚¹ï¼Œç°åœ¨æ ¹æ®ä¸Šçº¿çš„æƒ…å†µå¤§è‡´æè¿°ä¸€ä¸‹ï¼š

1. å‘Šè­¦é€šçŸ¥çš„ç›®æ ‡ä¸»æœºåº”è¯¥æœ‰è¿‡æ»¤æ¡ä»¶ï¼Œå…·ä½“æ¡ä»¶å°±æ˜¯è¯¥ä¸»æœºåœ¨æ¿€æ´»çŠ¶æ€ï¼Œä¸”ä¸ŠæŠ¥è¿‡ä¿¡æ¯ï¼Œè¯´ç™½äº†å°±æ˜¯åªå¯¹è¿™ç§æŒç»­ä¸ŠæŠ¥ï¼Œç„¶åçªç„¶ä¸­æ–­çš„ä¸»æœºè¿›è¡Œå‘Šè­¦é€šçŸ¥
2. ä½¿ç”¨å®šæ—¶ä»»åŠ¡æ£€æŸ¥ä¸»æœºä¸ŠæŠ¥çš„æ—¶é—´ï¼Œé€šè¿‡æœ€åä¸€æ¬¡ä¸ŠæŠ¥æ—¶é—´æ¥åˆ¤æ–­ä¸»æœºæ˜¯å¦æ‰çº¿ï¼Œå¹¶ä¸”æ‰çº¿å¤šä¹…
3. éœ€è¦è®¾ç½®é€šçŸ¥çš„é¢‘ç‡ï¼Œä¸èƒ½æ— è„‘å‘Šè­¦ï¼Œæ¯ä¸ªç¦»çº¿çš„ä¸»æœºåªåœ¨æŒ‡å®šçš„æ—¶é—´ç‚¹ä¸ŠæŠ¥ï¼Œæ¯”å¦‚æ‰çº¿1åˆ†é’Ÿã€10åˆ†é’Ÿã€60åˆ†é’Ÿã€4å°æ—¶å’Œ1æ•´ä½“è¿™å‡ ä¸ªé€’å¢çš„æ—¶é—´ç‚¹
4. é€šçŸ¥æ–¹å¼ä¸ºé‚®ä»¶é€šçŸ¥ï¼Œä½¿ç”¨Djangoè‡ªå¸¦çš„é€šçŸ¥åŠŸèƒ½


## åŠŸèƒ½å¼€å‘

### ç¼–å†™å®šæ—¶ä»»åŠ¡å‡½æ•°

å…ˆå†™ä¸€ä¸ªé€»è¾‘å¤„ç†å‡½æ•°ï¼Œå‡½æ•°çš„ä½œç”¨å°±æ˜¯æ‰¾å‡ºç¦»çº¿çš„ä¸»æœºï¼Œå¹¶å‘é€é‚®ä»¶é€šçŸ¥ï¼Œç›´æ¥çœ‹ä»£ç å§ï¼š

```python
import json
from datetime import datetime


def action_check_host_status(recipient_list=None, times=None):
    from django.conf import settings
    from django.core.mail import send_mail
    from .models import MonitorServer

    # å¯ä»¥é€šè¿‡å‚æ•°ä¼ é€’é€šçŸ¥çš„é¢‘ç‡
    times = times or [1, 10, 60, 60 * 4, 60 * 24]

    if not recipient_list:
        return 'No recipient_list, please set it.'

    if hasattr(settings, 'DEFAULT_FROM_EMAIL') and settings.DEFAULT_FROM_EMAIL:
        from_email = settings.DEFAULT_FROM_EMAIL
    else:
        # å¦‚æœæœªè®¾ç½®å‘ä»¶äººé‚®ç®±ï¼Œè®¾ç½®ä¸ºç©ºï¼Œç›´æ¥é€€å‡º
        return 'Email configuration not set'

    current_date = datetime.now()
    alarm_list = []
    hosts = MonitorServer.objects.filter(
        secret_key__isnull=False,
        secret_value__isnull=False,
        data__isnull=False,
        active=True
    )
    for host in hosts:
        # è½¬æ¢æˆåˆ†é’Ÿ
        m = int((current_date - host.update_date).total_seconds() / 60)
        # å¤šä¸ªæ—¶é—´ç‚¹å‘é€
        if m in times:
            msg = f'è­¦å‘Šï¼šèŠ‚ç‚¹ {host.name} ç¦»çº¿ {m} åˆ†é’Ÿ'
            alarm_list.append(msg)
        else:
            continue
    if all([alarm_list, from_email, recipient_list]):
        subject = f'âš ï¸æœåŠ¡ç›‘æ§å‘Šè­¦ {current_date.strftime("%Y-%m-%d %H:%M:%S")}'
        message = '\n'.join(alarm_list)
        ok_num = send_mail(subject, message, from_email, recipient_list)
        return f"Send email ok: {ok_num}"

    return "Not alarm !!!"

```

è¿™ä¸ªå‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼š

- recipient_listï¼šlistï¼Œé‚®ä»¶æ¥å—æ–¹ï¼Œæ”¯æŒå¤šä¸ªé‚®ç®±åœ°å€
- timesï¼šlistï¼Œé€šçŸ¥é¢‘ç‡ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¦»çº¿çš„å¤šä¸ªæ—¶é—´ç‚¹å‘é€šçŸ¥

ç„¶ååœ¨ tasks.py ä¸­è®¾ç½®æˆå®šæ—¶ä»»åŠ¡å‡½æ•°ï¼š

```python
@shared_task
def check_host_status(recipient_list=None, times=None):
    """
    å®šæ—¶æ£€æŸ¥æœåŠ¡ç›‘æ§çš„èŠ‚ç‚¹çŠ¶æ€
    å®šæ—¶ä»»åŠ¡éœ€è¦è®¾ç½®1åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    @param times: é€šçŸ¥é¢‘ç‡ï¼Œé»˜è®¤[1, 10, 60, 60 * 4, 60 * 24]
    @param recipient_list: æ”¶ä»¶äººçš„é‚®ä»¶åœ°å€ï¼Œå¿…å¡«ï¼Œå¦åˆ™ä¸æ£€æŸ¥
    @return:
    """
    response = TaskResponse()
    msg = action_check_host_status(recipient_list=recipient_list, times=times)
    response.data = {'msg': msg}
    return response.as_dict()
```

è¿™ä¸¤ä¸ªå‚æ•°éƒ½å¯ä»¥é€šè¿‡å®šæ—¶ä»»åŠ¡çš„å‚æ•°ä¼ é€’ç»™å‡½æ•°ã€‚

### é‚®ç®±é…ç½®

è¿™é‡Œéœ€è¦æåˆ°çš„æ˜¯ï¼Œç”±äºä½¿ç”¨äº† Django è‡ªå¸¦çš„é‚®ä»¶é€šçŸ¥èƒ½åŠ›ï¼Œæ‰€ä»¥éœ€è¦å…ˆåœ¨é¡¹ç›®çš„é…ç½®æ–‡ä»¶ä¸­é…ç½®å¥½é‚®ä»¶æœåŠ¡å™¨çš„ä¿¡æ¯ï¼Œè¿™ä¸ªåœ¨æˆ‘çš„é¡¹ç›®é‡Œé¢æ˜¯å¯ä»¥ä½¿ç”¨ç¯å¢ƒå˜é‡æ–‡ä»¶æ¥é…ç½®çš„ï¼Œå…·ä½“çš„é…ç½®é¡¹è§é¡¹ç›® settings.py æ–‡ä»¶ï¼š

```python
# ****************************************** é‚®ç®±é…ç½®å¼€å§‹ ****************************************
# é…ç½®ç®¡ç†é‚®ç®±ï¼ŒæœåŠ¡å‡ºç°æ•…éšœä¼šæ”¶åˆ°åˆ°é‚®ä»¶ï¼Œç¯å¢ƒå˜é‡å€¼çš„æ ¼å¼ï¼šname|test@test.com å¤šç»„ç”¨æˆ·ç”¨è‹±æ–‡é€—å·éš”å¼€
ADMINS = []
admin_email_user = os.getenv('IZONE_ADMIN_EMAIL_USER')
if admin_email_user:
    for each in admin_email_user.split(','):
        a_user, a_email = each.split('|')
        ADMINS.append((a_user, a_email))

# é‚®ç®±é…ç½®
EMAIL_HOST = os.getenv('IZONE_EMAIL_HOST', 'smtp.163.com')
EMAIL_HOST_USER = os.getenv('IZONE_EMAIL_HOST_USER', 'your-email-address')
EMAIL_HOST_PASSWORD = os.getenv('IZONE_EMAIL_HOST_PASSWORD',
                                'your-email-password')  # è¿™ä¸ªä¸æ˜¯é‚®ç®±å¯†ç ï¼Œè€Œæ˜¯æˆæƒç 
EMAIL_PORT = os.getenv('IZONE_EMAIL_PORT', 465)  # ç”±äºé˜¿é‡Œäº‘çš„25ç«¯å£æ‰“ä¸å¼€ï¼Œæ‰€ä»¥å¿…é¡»ä½¿ç”¨SSLç„¶åæ”¹ç”¨465ç«¯å£
EMAIL_TIMEOUT = 5
# æ˜¯å¦ä½¿ç”¨äº†SSL æˆ–è€…TLSï¼Œä¸ºäº†ç”¨465ç«¯å£ï¼Œè¦ä½¿ç”¨è¿™ä¸ª
EMAIL_USE_SSL = os.getenv('IZONE_EMAIL_USE_SSL', 'True').upper() == 'TRUE'
# é»˜è®¤å‘ä»¶äººï¼Œä¸è®¾ç½®çš„è¯djangoé»˜è®¤ä½¿ç”¨çš„webmaster@localhostï¼Œæ‰€ä»¥è¦è®¾ç½®æˆè‡ªå·±å¯ç”¨çš„é‚®ç®±
DEFAULT_FROM_EMAIL = os.getenv('IZONE_DEFAULT_FROM_EMAIL', 'TendCodeåšå®¢ <your-email-address>')
# *************************************** é‚®ç®±é…ç½®ç»“æŸ *******************************************
```

è¿™äº›é…ç½®æœ¬èº«æ˜¯ä½œä¸ºç”¨æˆ·æ³¨å†Œçš„é‚®ç®±è®¤è¯ï¼Œè¿˜æœ‰æœåŠ¡å¼‚å¸¸ç»™ç®¡ç†å‘˜é€šçŸ¥ç”¨çš„ï¼Œä½†æ˜¯ä¹Ÿæ˜¯ Django è‡ªå¸¦çš„é€šçŸ¥åŠŸèƒ½ï¼Œæ‰€ä»¥å¯ä»¥ä¸»åŠ¨è°ƒç”¨ã€‚

### è®¾ç½®å®šæ—¶ä»»åŠ¡

æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼Œå¹¶è®¾ç½®æ‰§è¡Œé¢‘ç‡ä¸º1åˆ†é’Ÿä¸€æ¬¡ï¼š

![](https://cdn.jsdelivr.net/gh/Hopetree/blog-img@main/2024/04/202404241137930.png)

å¹¶æ·»åŠ å®šæ—¶ä»»åŠ¡å‚æ•° `recipient_list ` å’Œ `times`ï¼Œå‰è€…ä¸ºé‚®ä»¶æ¥æ”¶æ–¹ï¼Œå¿…é¡»æœ‰å€¼ï¼Œåè€…ä¸ºé¢‘ç‡ï¼Œå¯ä»¥ä¸å¡«ç›´æ¥ä½¿ç”¨é»˜è®¤å€¼ã€‚

## éªŒè¯æ•ˆæœ

æ‰‹åŠ¨åœæ‰ä¸€ä¸ªä¸»æœºçš„ç›‘æ§é€šçŸ¥æœåŠ¡ï¼Œç”¨æ¥æ¨¡æ‹Ÿä¸»æœºæŒ‚äº†ï¼Œç„¶åç­‰å¾…1åˆ†é’Ÿï¼Œå°±å¯ä»¥æ”¶åˆ°é€šçŸ¥ï¼Œå¹¶ä¸”10åˆ†é’Ÿåå¯ä»¥æ”¶åˆ°ç¬¬äºŒæ¬¡é€šçŸ¥ã€‚

![](https://cdn.jsdelivr.net/gh/Hopetree/blog-img@main/2024/04/202404241142845.png)

## ä¼˜åŒ–

ç”±äºå®¶ç”¨å®½å¸¦æ¯48å°æ—¶å°±è¦æ›´æ–°ä¸€æ¬¡IPï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šå¯¼è‡´æ–­ç½‘ä¸€æ®µæ—¶é—´ï¼Œå› æ­¤ä¸ºäº†ä¿è¯è¿™ç§æœ‰è§„å¾‹çš„ç¦»çº¿ä¸è§¦å‘å‘Šè­¦ï¼Œå› æ­¤æˆ‘åœ¨ä»£ç ä¸­åŠ äº†ä¸€ä¸ªå‚æ•°ç”¨æ¥è¿‡æ»¤æ‰ä¸€äº›æ—¶é—´æ®µã€‚

ä¸‹é¢è¿™ä¸ªæ˜¯è¿‡æ»¤å‰çš„å‘Šè­¦ï¼Œæ¯48å°æ—¶å¿…å®šè§¦å‘å‘Šè­¦ï¼š

![](https://cdn.jsdelivr.net/gh/Hopetree/blog-img@main/2024/04/202405060949517.png)

æˆ‘æ·»åŠ çš„è¿‡æ»¤å‚æ•°ï¼š

```python
def action_check_host_status(recipient_list=None, times=None, ignore_hours=None):
    from django.conf import settings
    from django.core.mail import send_mail
    from .models import MonitorServer

    current_date = datetime.now()

    # å¿½ç•¥çš„æ£€æŸ¥æ—¶æ®µï¼Œè¿™äº›æ—¶æ®µä¸æ£€æŸ¥çŠ¶æ€
    # è¿™ä¸ªå¿½ç•¥çš„æ„ä¹‰æ˜¯å› ä¸ºè¿è¥å•†ä¼šå®šæœŸæ–­ç½‘æ›´æ–°IPï¼Œå¯¼è‡´ä¸ŠæŠ¥å¤±è´¥è§¦å‘å‘Šè­¦ï¼Œæ¯”å¦‚ç”µä¿¡æ˜¯4ç‚¹å¤šæ–­ç½‘ä¸€æ®µæ—¶é—´
    ignore_hours = ignore_hours or []

    if current_date.hour in ignore_hours:
        return f'Ignore period for {ignore_hours}, do not check.'
```

::: tip

ğŸ‰ **é¢˜å¤–è¯**

æœ‰å®šæ—¶ä»»åŠ¡å’Œæ²¡æœ‰å®šæ—¶ä»»åŠ¡çš„å¹³å°çœŸçš„æ˜¯ä¸¤ä¸ªå¹³å°ï¼Œåœ¨å®šæ—¶ä»»åŠ¡èƒ½åŠ›çš„æ”¯æŒä¸‹ï¼Œå¹³å°å¯ä»¥åšå¾ˆå¤šâ€œå¼‚æ­¥â€çš„äº‹æƒ…ï¼Œä¹Ÿå¯ä»¥åœ¨åå°åšå¾ˆå¤šæ¯”è¾ƒè€—æ—¶çš„äº‹æƒ…ï¼Œç®€ç›´ä¸è¦å¤ªçˆ½ï¼
:::