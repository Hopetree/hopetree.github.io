# Djangoåšå®¢è¯„è®ºåŒºæ˜¾ç¤ºç”¨æˆ·æ“ä½œç³»ç»Ÿä¸æµè§ˆå™¨ä¿¡æ¯

## éœ€æ±‚

### é¢„æœŸæ•ˆæœ

æˆ‘è§è¿‡ä¸€äº›åšå®¢çš„æ˜¾ç¤ºæ•ˆæœï¼Œå¤§å·®ä¸å·®ï¼Œæœ‰çš„è¿˜æ˜¾ç¤ºäº†IPæ‰€åœ¨åœ°ï¼Œä½†æ˜¯æˆ‘è§‰å¾—IPæ˜¯ä¸€ä¸ªæ¯”è¾ƒéšç§çš„ä¿¡æ¯ï¼Œè€Œä¸”å¾ˆå¤šéƒ½æ˜¯ä»£ç†IPæ²¡æœ‰æ„ä¹‰ã€‚ä¸‹é¢æ˜¯æˆªå–çš„å‡ ç§æ•ˆæœï¼Œéƒ½æ˜¯å¼€æºåšå®¢æ¡†æ¶çš„ã€‚

æ•ˆæœä¸€ï¼šç›´æ¥æ˜¾ç¤ºæµè§ˆå™¨ç‰ˆæœ¬å’Œæ“ä½œç³»ç»Ÿç‰ˆæœ¬ä¿¡æ¯

![user-agent](https://cdn.jsdelivr.net/gh/Hopetree/blog-img@main/2024/04/202408251337011.png)

æ•ˆæœäºŒï¼šç›´æ¥æ˜¾ç¤ºæµè§ˆå™¨å’Œæ“ä½œç³»ç»Ÿçš„å›¾æ ‡

![](https://cdn.jsdelivr.net/gh/Hopetree/blog-img@main/2024/04/202408251334384.png)

æ•ˆæœä¸‰ï¼šè¿™ä¸ªæ˜¯ [wordpress çš„æ’ä»¶](https://wordpress.org/plugins/show-useragent/ "wordpress çš„æ’ä»¶")ï¼Œæ˜¾ç¤ºIPæ‰€åœ¨å›½å®¶çš„æ——å¸œå’Œæ“ä½œç³»ç»Ÿã€æµè§ˆå™¨å›¾æ ‡

![](https://cdn.jsdelivr.net/gh/Hopetree/blog-img@main/2024/04/202408251345641.png)


æˆ‘çš„é¢„æœŸæ•ˆæœæ˜¯ç»“åˆä¸Šé¢çš„æ•ˆæœä¸€å’Œæ•ˆæœäºŒï¼Œæ‰€ä»¥æœ‰ä¸¤ä¸ªç‚¹éœ€è¦å®ç°ï¼š

1. åªæ˜¾ç¤ºç³»ç»Ÿå’Œæµè§ˆå™¨çš„å›¾æ ‡ï¼Œæ²¡æœ‰åŒ¹é…çš„åˆ™æ˜¾ç¤ºä¸€ä¸ªé»˜è®¤çš„å›¾æ ‡
2. å¹¶ä¸”é¼ æ ‡ç§»åŠ¨åˆ°å›¾æ ‡ä¸Šé¢çš„æ—¶å€™å¯ä»¥æ˜¾ç¤ºç³»ç»Ÿå’Œæµè§ˆå™¨çš„å…·ä½“ç‰ˆæœ¬ä¿¡æ¯ï¼Œæ²¡æœ‰ä¿¡æ¯åˆ™æ˜¾ç¤º Unknown


### éœ€æ±‚åˆ†æ

é¦–å…ˆå†™è¿‡çˆ¬è™«æˆ–è€…åç«¯çš„éƒ½çŸ¥é“ï¼ŒHTTP è¯·æ±‚æ˜¯æœ‰ä¸€ä¸ªè¯·æ±‚å¤´çš„æ¦‚å¿µï¼Œè€Œè¯·æ±‚å¤´é‡Œé¢æœ‰ä¸ªå­—æ®µå« User-Agent å°±æ˜¯è¯·æ±‚çš„æµè§ˆå™¨ä¿¡æ¯ï¼Œä¸€èˆ¬å¯ä»¥ä»è¿™ä¸ªä¿¡æ¯ä¸­è¯†åˆ«è¯·æ±‚æ˜¯ä»€ä¹ˆæ“ä½œç³»ç»Ÿå’Œä»€ä¹ˆæµè§ˆå™¨å‘å‡ºçš„ï¼Œå½“ç„¶ï¼Œä¹Ÿæœ‰æ˜¯æœç´¢å¼•æ“çˆ¬è™«æˆ–è€…ä¼ªè£…çš„ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ä»åç«¯æ¥å£ä¸­å»è·å–è¿™ä¸ªä¿¡æ¯ï¼Œç„¶ååˆ†æ User-Agent çš„ä¿¡æ¯è¿›è¡Œåˆ†ç±»ï¼Œç„¶åå‰ç«¯æ˜¾ç¤ºå‡ºæ¥å³å¯ã€‚

äºæ˜¯ï¼ŒåŸºäºè¿™ä¸ªéœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦è§£å†³ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

1. å¦‚ä½•å°†ç”¨æˆ·çš„è¯·æ±‚ User-Agent ä¼ é€’ç»™åç«¯ä»¥ä¿è¯åç«¯å¯ä»¥æ‹¿åˆ°è¿™ä¸ªä¿¡æ¯ï¼Ÿ
2. å¦‚ä½•å­˜å‚¨ User-Agent ä¿¡æ¯ï¼Ÿ
3. å¦‚ä½•è§£æ User-Agent ä¿¡æ¯ï¼Ÿ
4. å¦‚ä½•å°†è§£æåçš„ User-Agent ä¿¡æ¯ç”¨å›¾æ ‡çš„å½¢å¼æ˜¾ç¤ºåˆ°å‰ç«¯ï¼Ÿ

## åŠŸèƒ½å®ç°

ä¸‹é¢å°±ä¸Šæ–‡æåˆ°çš„å‡ ä¸ªéœ€æ±‚åˆ†æçš„é—®é¢˜å±•å¼€è¯´ä¸€ä¸‹æˆ‘æ˜¯å¦‚ä½•åšçš„ã€‚

### User-Agent çš„è·å–

åç«¯æƒ³è¦è·å–åˆ°ç”¨æˆ·çš„ User-Agent ä¿¡æ¯å…¶å®å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„äº‹æƒ…ï¼Œè¿™éœ€è¦åˆ†æä¸€ä¸‹ä»ç”¨æˆ·ç‚¹å‡»æµè§ˆå™¨çš„æäº¤æŒ‰é’®åˆ°åç«¯æ”¶åˆ°æ¥å£è¯·æ±‚çš„è¿‡ç¨‹ç»å†äº†äº›ä»€ä¹ˆã€‚

ä»¥æˆ‘çš„åšå®¢ä¸ºä¾‹ï¼Œç”¨æˆ·æäº¤è¯·æ±‚åï¼Œè¯·æ±‚ä¼šå…ˆèµ°åˆ°æˆ‘äº‘æœåŠ¡å™¨çš„ Nginxï¼Œç„¶å Nginx ä¼šæŠŠè¯·æ±‚è½¬å‘ç»™åå‘ä»£ç†çš„æœåŠ¡ï¼Œä¹Ÿå°±æ˜¯æˆ‘ izone-docker é‡Œé¢çš„ Nginx å®¹å™¨ï¼Œæ¥ç€ Nginx å®¹å™¨å†æŠŠè¯·æ±‚è½¬å‘ç»™ Django å®¹å™¨ï¼Œå¤§è‡´æ¶æ„æ˜¯è¿™æ ·çš„ï¼š

![](https://cdn.jsdelivr.net/gh/Hopetree/blog-img@main/2024/04/202408251408599.png)

ä¹Ÿå°±æ˜¯è¯´ç”¨æˆ·è¦æŠŠ User-Agent ä¿¡æ¯ä¼ åˆ°åç«¯å®é™…ä¸Šæ˜¯è¦èµ°ä¸¤ä¸ª Nginxï¼Œè€Œ Nginx è¦å°†è¯·æ±‚å¤´ä¿¡æ¯ä¼ é€’åˆ°åå‘ä»£ç†çš„æœåŠ¡å™¨ï¼Œæ˜¯éœ€è¦è¿›è¡Œé…ç½®çš„ï¼Œå…·ä½“é…ç½®è¿™ä¸ª User-Agent ä¿¡æ¯æ˜¯è¿™æ ·çš„ï¼š

```nginx
proxy_set_header X-User-Agent $http_user_agent;
```

æˆ‘çš„[å®¹å™¨ Nginx é‡Œé¢çš„é…ç½®](https://github.com/Hopetree/izone-docker/blob/master/nginx/conf.d/izone.conf "å®¹å™¨ Nginx é‡Œé¢çš„é…ç½®")æ˜¯æœ¬èº«å°±é…ç½®äº†è¿™ä¸ªè¯·æ±‚å¤´çš„ï¼Œæ‰€ä»¥åªéœ€è¦åœ¨æœåŠ¡å™¨æœ¬åœ°çš„ Nginx çš„é…ç½®é‡Œä¹Ÿæ·»åŠ ä¸Šè¿™ä¸ªé…ç½®å°±è¡Œã€‚

æ­¤æ—¶åœ¨ Django é‡Œé¢çš„è§†å›¾å‡½æ•°ä¸­è·å– User-Agent å°±å¯ä»¥åƒè¿™æ ·ï¼š

```python
user_agent_string = request.META.get('HTTP_USER_AGENT', 'unknown')
```

### User-Agent çš„å­˜å‚¨

æˆ‘çš„éœ€æ±‚æ˜¯æ˜¾ç¤ºæ¯ä¸ªè¯„è®ºä¿¡æ¯çš„ User-Agent ä¿¡æ¯ï¼Œæ‰€ä»¥å½“ç„¶æ˜¯éœ€è¦ç»™è¯„è®ºæ¨¡å‹æ·»åŠ ä¸€ä¸ªå­—æ®µæ¥å­˜å‚¨è¿™ä¸ªä¿¡æ¯ï¼Œå­—æ®µè®¾ç½®æˆå¯ä¸å¡«ä¹Ÿå¯ä»¥å¡«å†™ç©ºå€¼ï¼š

```python
class Comment(models.Model):
    # è®°å½•å¤„ç†åçš„user-agent
    # æ ¼å¼ PC / Mac OS X 10.15.7 / Chrome 128.0.0ï¼Œå¯ä»¥ä½¿ç”¨ / æ¥æ‹†åˆ†
    user_agent = models.CharField(max_length=255, blank=True, null=True)
```

æ–°å¢æ¨¡å‹å­—æ®µï¼Œåˆ«å¿˜äº†æ‰§è¡Œ `makemigrations` å’Œ `migrate` å‘½ä»¤æ›´æ–°æ•°æ®è¡¨ã€‚

### User-Agent çš„è§£æ

ç”±äº User-Agent çš„ä¿¡æ¯ä¼šæ ¹æ®ä¸åŒç³»ç»Ÿç‰ˆæœ¬ã€æµè§ˆå™¨ç‰ˆæœ¬ç­‰ä¿¡æ¯ç»„åˆæˆä¸åŒçš„ä¿¡æ¯ï¼Œç›´æ¥å­˜å‚¨è¿™ä¸ªä¿¡æ¯æ²¡æœ‰å¤ªå¤§çš„æ„ä¹‰ï¼Œæ‰€ä»¥éœ€è¦å¤„ç†æˆè¦æ˜¾ç¤ºçš„æ•ˆæœå†å­˜å‚¨ï¼Œè¿™é‡Œä½¿ç”¨ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ `user-agents` æ¥å¤„ç†ã€‚

å…ˆå®‰è£…ä¾èµ–ï¼š

```bash
pip install pyyaml ua-parser user-agents
```

ç„¶åè¿›è¡Œè§£æå’Œå­˜å‚¨ï¼Œè¿™é‡Œæˆ‘ç›´æ¥å­˜å‚¨å¤„ç†åçš„å­—ç¬¦ä¸²ï¼š

```python
user_agent = parse(user_agent_string)

...

new_comment = ArticleComment(author=new_user, 
	content=new_content,
	belong=the_article,
	parent=None,
	rep_to=None,
	user_agent=str(user_agent))
```

è¿™é‡Œçš„ `str(user_agent)` å†…å®¹æ˜¯è¿™æ ·çš„ â€œPC / Mac OS X 10.15.7 / Chrome 128.0.0â€ï¼Œä½¿ç”¨çš„ â€œ/â€ è¿æ¥çš„ä¸‰ä¸ªä¿¡æ¯ï¼Œç¬¬ä¸€ä¸ªæ˜¯å¹³å°ç±»å‹ï¼Œç¬¬äºŒä¸ªæ˜¯ç³»ç»Ÿç‰ˆæœ¬ï¼Œç¬¬ä¸‰ä¸ªæ˜¯æµè§ˆå™¨ç‰ˆæœ¬ã€‚

æ›´å¤š `user-agents` çš„ç”¨æ³•å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹å®˜æ–¹æŒ‡å¯¼çš„æ¼”ç¤ºï¼Œéå¸¸ç®€ç­”ï¼š

```python
from user_agents import parse

# iPhone's user agent string
ua_string = 'Mozilla/5.0 (iPhone; CPU iPhone OS 5_1 like Mac OS X) AppleWebKit/534.46 (KHTML, like Gecko) Version/5.1 Mobile/9B179 Safari/7534.48.3'
user_agent = parse(ua_string)

# Accessing user agent's browser attributes
user_agent.browser  # returns Browser(family=u'Mobile Safari', version=(5, 1), version_string='5.1')
user_agent.browser.family  # returns 'Mobile Safari'
user_agent.browser.version  # returns (5, 1)
user_agent.browser.version_string   # returns '5.1'

# Accessing user agent's operating system properties
user_agent.os  # returns OperatingSystem(family=u'iOS', version=(5, 1), version_string='5.1')
user_agent.os.family  # returns 'iOS'
user_agent.os.version  # returns (5, 1)
user_agent.os.version_string  # returns '5.1'

# Accessing user agent's device properties
user_agent.device  # returns Device(family=u'iPhone', brand=u'Apple', model=u'iPhone')
user_agent.device.family  # returns 'iPhone'
user_agent.device.brand # returns 'Apple'
user_agent.device.model # returns 'iPhone'

# Viewing a pretty string version
str(user_agent) # returns "iPhone / iOS 5.1 / Mobile Safari 5.1"
```

### User-Agent çš„æ˜¾ç¤º

æˆ‘å­˜å…¥æ¨¡å‹å­—æ®µçš„æ ¼å¼æ˜¯ â€œPC / Mac OS X 10.15.7 / Chrome 128.0.0â€ è¿™ç§ï¼Œè€Œæˆ‘éœ€è¦çš„ä¹Ÿå°±æ˜¯æ“ä½œç³»ç»Ÿç‰ˆæœ¬å’Œæµè§ˆå™¨ç‰ˆæœ¬ï¼Œäºæ˜¯ç›´æ¥è¯»å–è¯„è®ºçš„å­—æ®µç„¶åå†æ¬¡å¤„ç†ä¸€ä¸‹å°±è¡Œï¼Œå¤„ç†å°±æ˜¯æŠŠä¸€äº›å¸¸è§çš„ç³»ç»Ÿè®¾ç½®æˆå›¾æ ‡ï¼Œäºæ˜¯éœ€è¦æ›´å…·ç³»ç»Ÿå’Œæµè§ˆå™¨ä¿¡æ¯è·å–ä¸€ä¸ªå¯¹åº”çš„å›¾æ ‡åç§°ã€‚

#### å®šä¹‰å›¾æ ‡æ˜ å°„å…³ç³»çš„æ ‡ç­¾å‡½æ•°

è‡ªå®šä¹‰ä¸€ä¸ªæ ‡ç­¾å‡½æ•°ï¼Œç”¨æ¥æŠŠå­˜å‚¨çš„ user_agent è½¬æˆ html ä¸­è¦æ˜¾ç¤ºçš„ä¿¡æ¯å’Œå›¾æ ‡åç§°ï¼Œå‡½æ•°è¿”å›ä¸€ä¸ªå­—å…¸ã€‚

```python
@register.simple_tag
def split_user_agent(user_agent):
    """
    å°†è¯„è®ºä¸­çš„æµè§ˆå™¨ä¿¡æ¯è§£ææˆç³»ç»Ÿç‰ˆæœ¬å’Œæµè§ˆå™¨ç‰ˆæœ¬
    @param user_agent: PC / Windows 7 / Chrome 55.0.2891
    @return: Windows 7,Chrome 55.0.2891,windows,chrome
    """
    system_dict = {
        'Windows': 'Windows',
        'Mac': 'Mac',
        'iOS': 'iOS',
        'Android': 'Android',
        'Ubuntu': 'Ubuntu',
        'Linux': 'Linux',
    }
    browser_dict = {
        'Chrome': 'Chrome',
        'Firefox': 'Firefox',
        'Safari': 'Safari',
        'Edge': 'Edge',
        'IE': 'IE',
        'Opera': 'Opera'
    }
    system_info, browser_info = 'Unknown', 'Unknown'
    system_img, browser_img = 'other_system', 'other_browser'
    if user_agent and len(user_agent.split(' / ')) == 3:
        _, system_info, browser_info = user_agent.split(' / ')
        for k, v in system_dict.items():
            if system_info.strip().startswith(k):
                system_img = v
                break
        for k, v in browser_dict.items():
            if browser_info.strip().startswith(k):
                browser_img = v
                break
    return {
        'system_info': system_info.strip(),
        'browser_info': browser_info.strip(),
        'system_img': system_img,
        'browser_img': browser_img
    }
```

#### å®šä¹‰é¡µé¢ html å’Œæ ‡ç­¾å‡½æ•°

é¦–å…ˆåˆ›å»ºä¸€ä¸ª html ç”¨æ¥æ˜¾ç¤ºå›¾æ ‡æ•ˆæœï¼š

```html
{% load static comment_tags %}

{% split_user_agent user_agent as user_agent_dict %}
<img class="mx-1"
     src="{% static 'comment/img/'|add:user_agent_dict.browser_img|add:'.png' %}"
     alt="{{ user_agent_dict.browser_info }}" title="{{ user_agent_dict.browser_info }}"
     style="display: inline-block;height: 1rem;">
<img class="mx-0"
     src="{% static 'comment/img/'|add:user_agent_dict.system_img|add:'.png' %}"
     alt="{{ user_agent_dict.system_info }}" title="{{ user_agent_dict.system_info }}"
     style="display: inline-block;height: 1rem;">
```

ç„¶åå†å®šä¹‰ä¸€ä¸ªæ ‡ç­¾å‡½æ•°ï¼Œç”¨æ¥è¿”å›è¿™ä¸ª html ç‰‡æ®µï¼š

```python
@register.inclusion_tag('comment/tags/user_agent.html')
def load_user_agent_img(user_agent):
    """
    åŠ è½½user_agenté¡µé¢å†…å®¹
    @param user_agent:
    @return:
    """
    return {'user_agent': user_agent}
```

æœ€ååœ¨è¯„è®ºåˆ—è¡¨ä¸­æ˜¾ç¤ºè¿™ä¸ªç‰‡æ®µï¼š

```html
{% if each.user_agent %}
	{% load_user_agent_img each.user_agent %}
{% endif %}
```

#### ä¸Šä¼ å›¾æ ‡æ–‡ä»¶

åœ¨ html é‡Œé¢æ˜¯æ ¹æ®å›¾æ ‡åç§°æ¥æ˜¾ç¤ºå…·ä½“çš„æ“ä½œç³»ç»Ÿå’Œæµè§ˆå™¨å›¾æ ‡çš„ï¼Œå› æ­¤åªéœ€æŒ‰ç…§å‰é¢å®šä¹‰çš„æ˜ å°„å­—å…¸å…³ç³»ä¸Šä¼ ä¸€äº›å›¾æ ‡åˆ°æŒ‡å®šç›®å½•å³å¯ï¼Œå…·ä½“å¦‚ä¸‹ï¼š

![](https://cdn.jsdelivr.net/gh/Hopetree/blog-img@main/2024/04/202408251456570.png)


## ğŸ‰ å®ç°æ•ˆæœ

æœ€åæ¥çœ‹çœ‹æˆ‘å®ç°åçš„æ•ˆæœï¼Œå®Œç¾æŒ‰ç…§æˆ‘çš„é¢„æƒ³å®ç°çš„ã€‚

![](https://cdn.jsdelivr.net/gh/Hopetree/blog-img@main/2024/04/202408251438838.png)